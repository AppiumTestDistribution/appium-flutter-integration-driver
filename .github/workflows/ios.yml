on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

name: iOS Appium Flutter Integration Driver
jobs:
  Build_IOS_App_With_Server:
    runs-on: macos-latest
    strategy:
      matrix:
        api-level: [ 29 ]
        target: [ google_apis ]
    steps:
      - name: Check out my other private repo
        uses: actions/checkout@master
        with:
          path: 'server'
          repository: AppiumTestDistribution/appium-flutter-server
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.22.1
          channel: 'stable'
      - run: |
          ls
          cd server/demo-app
          flutter build ios integration_test/appium.dart  --simulator
      - name: "List files"
        continue-on-error: true
        run: |
          ls -l ${{ github.workspace }}/server/demo-app/build/ios/iphonesimulator/
      - name: "Zip files"
        run: |
          cd ${{ github.workspace }}/server/demo-app/build/ios/iphonesimulator/
          zip -r ios.zip Runner.app
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: ${{ github.workspace }}/server/demo-app/build/ios/iphonesimulator/ios.zip

  Run_iOS_Tests:
    needs: Build_IOS_App_With_Server
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      - uses: dawidd6/action-download-artifact@v3
        with:
          name: ios
      - name: Display structure of downloaded files
        run: ls -R
      - name: Run WDIO iOS Test
        run: |
          npm install
          npm run build
          appium driver list
          npm run wdio-ios
